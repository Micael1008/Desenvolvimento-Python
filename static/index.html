<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Projetos - Projeto RAD</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: auto;
            min-height: 350px;
            margin-left: auto;
            margin-right: auto;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            display: none;
            max-height: 90vh; /* Garante que o modal não ultrapasse a altura da tela */
            overflow-y: auto;  /* Adiciona scroll se o conteúdo for maior */
        }
        .flash-message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        .flash-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .flash-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6fb;
        }
        .flash-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #change-password-view {
            display: none; 
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 transition-colors duration-300">

    <header class="bg-slate-800/80 backdrop-blur-lg shadow-sm shadow-black/20 sticky top-0 z-30">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="#" id="logo" class="text-2xl font-bold text-indigo-400">GestorPro</a>
                </div>
                <div class="flex items-center gap-4">
                    <div id="nav-links" class="hidden md:block">
                        <!-- Links de navegação são renderizados aqui  -->
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="flash-messages" class="mb-4"></div>
        <section id="landing-view" class="view">
            <div class="text-center py-16">
                <h1 class="text-4xl md:text-5xl font-extrabold text-white">
                    Organize os seus projetos com <span class="text-indigo-400">facilidade</span>.
                </h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-slate-400">
                    Uma ferramenta simples e poderosa para gerir as suas tarefas, acompanhar o progresso e colaborar com a sua equipa. Cumpra os requisitos do seu projeto RAD com uma interface de alta performance.
                </p>
                <div class="mt-8 flex justify-center gap-4">
                    <button data-target="login-view" class="nav-button bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition">
                        Entrar
                    </button>
                    <button data-target="signup-view" class="nav-button bg-slate-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-slate-600 transition">
                        Criar Conta
                    </button>
                </div>
            </div>
        </section>

        <section id="login-view" class="view">
            <div class="max-w-md mx-auto bg-slate-800 p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6 text-white">Acesso</h2>
                <p class="text-center text-slate-400 mb-6">Bem-vindo de volta! Insira as suas credenciais para aceder ao seu painel.</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-slate-300 mb-1">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-slate-300 mb-1">Senha</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Entrar</button>
                </form>
                   <p class="text-center text-sm text-slate-400 mt-6">
                       Não tem uma conta? <button data-target="signup-view" class="nav-button font-semibold text-indigo-400 hover:underline">Registe-se</button>
                   </p>
                <p class="text-center text-sm text-slate-400 mt-2">
                    <button data-target="forgot-password-view" class="nav-button font-semibold text-indigo-400 hover:underline">Esqueceu a senha?</button>
                </p>
            </div>
        </section>

        <section id="signup-view" class="view">
            <div class="max-w-md mx-auto bg-slate-800 p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6 text-white">Criar Nova Conta</h2>
                <p class="text-center text-slate-400 mb-6">Preencha os campos abaixo para iniciar a sua jornada de produtividade.</p>
                <form id="signup-form">
                    <div class="mb-4">
                        <label for="signup-name" class="block text-sm font-medium text-slate-300 mb-1">Nome Completo</label>
                        <input type="text" id="signup-name" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-slate-300 mb-1">Email</label>
                        <input type="email" id="signup-email" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-medium text-slate-300 mb-1">Senha</label>
                        <input type="password" id="signup-password" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Criar Conta</button>
                </form>
                   <p class="text-center text-sm text-slate-400 mt-6">
                       Já possui uma conta? <button data-target="login-view" class="nav-button font-semibold text-indigo-400 hover:underline">Faça acesso</button>
                   </p>
            </div>
        </section>

        <section id="forgot-password-view" class="view">
            <div class="max-w-md mx-auto bg-slate-800 p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6 text-white">Esqueceu a Senha?</h2>
                <p class="text-center text-slate-400 mb-6">Insira o seu email para receber um link de redefinição de senha.</p>
                <form id="forgot-password-form">
                    <div class="mb-4">
                        <label for="forgot-email" class="block text-sm font-medium text-slate-300 mb-1">Email</label>
                        <input type="email" id="forgot-email" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Enviar Link</button>
                </form>
                <p class="text-center text-sm text-slate-400 mt-6">
                    Lembrou-se? <button data-target="login-view" class="nav-button font-semibold text-indigo-400 hover:underline">Faça acesso</button>
                </p>
            </div>
        </section>

        <section id="reset-password-view" class="view">
            <div class="max-w-md mx-auto bg-slate-800 p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6 text-white">Redefinir Senha</h2>
                <p class="text-center text-slate-400 mb-6">Insira e confirme a sua nova senha.</p>
                <form id="reset-password-form">
                    <input type="hidden" id="reset-token">
                    <div class="mb-4">
                        <label for="reset-password" class="block text-sm font-medium text-slate-300 mb-1">Nova Senha</label>
                        <input type="password" id="reset-password" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="reset-confirm-password" class="block text-sm font-medium text-slate-300 mb-1">Confirmar Nova Senha</label>
                        <input type="password" id="reset-confirm-password" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Redefinir Senha</button>
                </form>
            </div>
        </section>

        <section id="change-password-view" class="view">
            <div class="max-w-md mx-auto bg-slate-800 p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6 text-white">Alterar Senha</h2>
                <p class="text-center text-slate-400 mb-6">A sua conta requer que altere a sua senha.</p>
                <form id="forced-change-password-form">
                    <div class="mb-4">
                        <label for="forced-current-password" class="block text-sm font-medium text-slate-300 mb-1">Senha Atual</label>
                        <input type="password" id="forced-current-password" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="forced-new-password" class="block text-sm font-medium text-slate-300 mb-1">Nova Senha</label>
                        <input type="password" id="forced-new-password" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="forced-confirm-new-password" class="block text-sm font-medium text-slate-300 mb-1">Confirmar Nova Senha</label>
                        <input type="password" id="forced-confirm-new-password" class="w-full px-4 py-2 border border-slate-600 bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Alterar Senha</button>
                </form>
            </div>
        </section>


        <section id="dashboard-view" class="view">
            <h1 class="text-3xl font-bold mb-6 text-white" id="welcome-message"></h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 text-white">Perfil do Utilizador</h2>
                        <div id="profile-details" class="space-y-3 text-slate-400">
                        </div>
                        <button id="edit-profile-btn" class="mt-4 bg-slate-700 text-slate-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition">
                            Editar Perfil
                        </button>
                    </div>

                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 text-white">Estado dos Projetos</h2>
                        <div class="chart-container">
                            <canvas id="project-status-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-slate-800 p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Os meus Projetos</h2>
                        <button id="add-project-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">
                            Novo Projeto
                        </button>
                    </div>
                    <p class="text-slate-400 mb-6">Esta é a sua aplicação principal. Aqui pode criar, visualizar, editar e remover projetos, demonstrando um ciclo CRUD completo.</p>
                    <div id="project-list" class="space-y-4">
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="project-modal" class="modal w-full max-w-lg bg-slate-800 p-8 rounded-xl shadow-2xl">
        <h2 id="modal-title" class="text-2xl font-bold mb-6 text-white"></h2>
        <form id="project-form">
            <input type="hidden" id="project-id">
            <div class="mb-4">
                <label for="project-name" class="block text-sm font-medium text-slate-300 mb-1">Nome do Projeto</label>
                <input type="text" id="project-name" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
            </div>
            <div class="mb-4">
                <label for="project-description" class="block text-sm font-medium text-slate-300 mb-1">Descrição</label>
                <textarea id="project-description" rows="3" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
            </div>
            <div class="mb-6">
                <label for="project-status" class="block text-sm font-medium text-slate-300 mb-1">Estado</label>
                <select id="project-status" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="A Fazer">A Fazer</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Concluído">Concluído</option>
                </select>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-project-btn" class="bg-slate-600 text-slate-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition">Cancelar</button>
                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Salvar</button>
            </div>
        </form>
    </div>

    <div id="profile-modal" class="modal w-full max-w-lg bg-slate-800 p-8 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-bold mb-6 text-white">Editar Perfil</h2>
        <form id="profile-edit-form">
            <div class="mb-4">
                <label for="profile-name" class="block text-sm font-medium text-slate-300 mb-1">Nome Completo</label>
                <input type="text" id="profile-name" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-4">
                <label for="profile-contact" class="block text-sm font-medium text-slate-300 mb-1">Contato (11 dígitos)</label>
                <input type="text" id="profile-contact" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-6">
                <label for="profile-photo" class="block text-sm font-medium text-slate-300 mb-1">URL da Foto de Perfil</label>
                <input type="text" id="profile-photo" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Ex: https://example.com/minhafoto.jpg">
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-profile-btn" class="bg-slate-600 text-slate-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition">Cancelar</button>
                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Salvar</button>
            </div>
        </form>
        <h3 class="text-xl font-bold mt-8 mb-4 text-white">Alterar Senha</h3>
        <form id="change-password-form">
            <div class="mb-4">
                <label for="current-password" class="block text-sm font-medium text-slate-300 mb-1">Senha Atual</label>
                <input type="password" id="current-password" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
            </div>
            <div class="mb-4">
                <label for="new-password" class="block text-sm font-medium text-slate-300 mb-1">Nova Senha</label>
                <input type="password" id="new-password" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
            </div>
            <div class="mb-6">
                <label for="confirm-new-password" class="block text-sm font-medium text-slate-300 mb-1">Confirmar Nova Senha</label>
                <input type="password" id="confirm-new-password" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
            </div>
            <div class="flex justify-end">
                 <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Atualizar Senha</button>
            </div>
        </form>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Estado Global da Aplicação ---
    let appState = {
        isAuthenticated: false,
        currentView: 'landing', // 'landing', 'login', 'signup', 'dashboard', 'forgot-password', 'reset-password', 'change-password'
        currentUser: null,  // Detalhes do utilizador com sessão iniciada
        projects: [],       // Projetos do utilizador com sessão iniciada
        resetToken: null,   // Para a vista de redefinição de senha
    };
    
    // --- Elementos do DOM ---
    const views = document.querySelectorAll('.view');
    const navLinksContainer = document.getElementById('nav-links');
    const welcomeMessage = document.getElementById('welcome-message');
    const profileDetails = document.getElementById('profile-details');
    const projectList = document.getElementById('project-list');
    const flashMessagesContainer = document.getElementById('flash-messages');
    
    // Modais
    const modalBackdrop = document.getElementById('modal-backdrop');
    const projectModal = document.getElementById('project-modal');
    const projectForm = document.getElementById('project-form');
    const modalTitle = document.getElementById('modal-title');
    const profileModal = document.getElementById('profile-modal');
    
    let statusChart = null; // Instância do Chart.js

    // --- Funções de Utilitário ---
    function showFlashMessage(message, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flash-message ${type} mb-4`;
        messageDiv.textContent = message;
        flashMessagesContainer.innerHTML = ''; // Limpa mensagens anteriores
        flashMessagesContainer.appendChild(messageDiv);
        setTimeout(() => {
            messageDiv.remove();
        }, 5000); // Remove a mensagem após 5 segundos
    }

    async function fetchData(url, method = 'GET', data = null) {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
        };
        if (data) {
            options.body = JSON.stringify(data);
        }
        try {
            const response = await fetch(url, options); 
            const result = await response.json();
            if (!response.ok) {
                showFlashMessage(result.message || 'Ocorreu um erro', 'error');
                return null;
            }
            return result;
        } catch (error) {
            console.error('Erro na requisição:', error);
            showFlashMessage('Erro de conexão ou servidor. Verifique o console para mais detalhes.', 'error');
            return null;
        }
    }

    // --- Funções de Navegação e Renderização das Vistas ---
    function renderNav() {
        let links = '';
        if (appState.isAuthenticated) {
            links = `
                <div class="flex items-center space-x-4">
                    <span class="text-slate-400">Olá, <span class="font-semibold text-white">${appState.currentUser.nome.split(' ')[0]}</span></span>
                    <button id="logout-btn" class="bg-slate-700 text-slate-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition">Sair</button>
                </div>
            `;
        } else {
            links = ``;
        }
        navLinksContainer.innerHTML = links;
    }
    
    function renderProfileDetails() {
        if (!appState.currentUser) return;
        profileDetails.innerHTML = `
            <p><strong>Nome:</strong> ${appState.currentUser.nome || 'Não informado'}</p>
            <p><strong>Email:</strong> ${appState.currentUser.email}</p>
            <p><strong>Contato:</strong> ${appState.currentUser.contato || 'Não informado'}</p>
            <p><strong>Tipo:</strong> ${appState.currentUser.tipoUsuario ? 'Administrador' : 'Utilizador'}</p>
            ${appState.currentUser.mudaSenha ? '<p class="text-red-500 font-bold mt-2">A sua senha precisa de ser alterada!</p>' : ''}
        `;
    }
    
    function renderProjects() {
        if (appState.projects.length === 0) {
            projectList.innerHTML = `<div class="text-center py-12 px-6 bg-slate-800/50 rounded-lg">
                <h3 class="font-semibold text-white">Nenhum projeto encontrado.</h3>
                <p class="text-slate-400 mt-1">Clique em "Novo Projeto" para começar a organizar o seu trabalho.</p>
            </div>`;
            return;
        }

        projectList.innerHTML = appState.projects.map(p => `
            <div class="project-item border border-slate-700 p-4 rounded-lg flex justify-between items-center transition hover:shadow-md hover:border-indigo-500">
                <div>
                    <h3 class="font-bold text-lg text-white">${p.name}</h3>
                    <p class="text-slate-400 text-sm">${p.description}</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium px-3 py-1 rounded-full ${
                        p.status === 'Concluído' ? 'bg-green-900/50 text-green-300' :
                        p.status === 'Em Andamento' ? 'bg-yellow-900/50 text-yellow-300' :
                        'bg-slate-700 text-slate-300'
                    }">
                        ${p.status}
                    </span>
                    <button data-id="${p.id}" class="edit-project-btn text-slate-400 hover:text-indigo-400">Editar</button>
                    <button data-id="${p.id}" class="delete-project-btn text-slate-400 hover:text-red-400">Eliminar</button>
                </div>
            </div>
        `).join('');
    }

    function renderChart() {
        if (statusChart) {
            statusChart.destroy();
        }
        const legendColor = '#d1d5db';

        const ctx = document.getElementById('project-status-chart').getContext('2d');
        const statusCounts = appState.projects.reduce((acc, p) => {
            acc[p.status] = (acc[p.status] || 0) + 1;
            return acc;
        }, {});
        
        const data = {
            labels: Object.keys(statusCounts).length > 0 ? Object.keys(statusCounts) : ['Nenhum Projeto'],
            datasets: [{
                label: 'Projetos',
                data: Object.keys(statusCounts).length > 0 ? Object.values(statusCounts) : [1],
                backgroundColor: Object.keys(statusCounts).length > 0 ? [
                    '#4b5563', // A Fazer
                    '#d97706', // Em Andamento
                    '#059669', // Concluído
                ] : ['#374151'],
                borderColor: '#1f2937',
                borderWidth: 2,
            }]
        };

        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: legendColor }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => Object.keys(statusCounts).length > 0 ? `${context.label}: ${context.parsed}` : 'Sem dados'
                        }
                    }
                }
            }
        });
    }

    // Função para renderizar todos os componentes dinâmicos
    function renderAll() {
        renderNav();
    }
    
    async function renderDashboard() {
        if (!appState.isAuthenticated) return;
        
        welcomeMessage.textContent = `Bem-vindo(a) de volta, ${appState.currentUser.nome.split(' ')[0]}!`;
        
        const profileData = await fetchData('/api/profile');
        if (profileData) {
            appState.currentUser = { ...appState.currentUser, ...profileData };
            renderProfileDetails();
        }

        const projectsData = await fetchData('/api/projects');
        if (projectsData) {
            appState.projects = projectsData;
            renderProjects();
            renderChart();
        }

        if (appState.currentUser.mudaSenha) {
            navigate('change-password-view');
        }
    }

    function navigate(viewName) {
        let targetView = viewName.startsWith('#') ? viewName : viewName.replace('-view', '');
        
        if (targetView.startsWith('#reset-password-')) {
            appState.resetToken = targetView.replace('#reset-password-', '');
            appState.currentView = 'reset-password';
        } else {
            appState.currentView = targetView;
            appState.resetToken = null;
        }

        views.forEach(view => {
            view.classList.toggle('active', view.id === appState.currentView + '-view');
        });

        if (appState.currentView === 'reset-password' && appState.resetToken) {
            document.getElementById('reset-token').value = appState.resetToken;
        }

        if(appState.currentView === 'dashboard') {
            renderDashboard();
        }

        renderAll(); // Garante que a UI sempre reflita o estado atual
    }

    async function checkAuthStatus() {
        const result = await fetchData('/api/auth_status');
        appState.isAuthenticated = result && result.isAuthenticated;
        if (appState.isAuthenticated) {
            appState.currentUser = result.user;
            const hash = window.location.hash;
            if (appState.currentUser.mudaSenha) {
                navigate('change-password-view');
            } else if (hash && hash.startsWith('#reset-password-')) {
                window.location.hash = '';
                navigate('dashboard');
            } else {
                 navigate('dashboard');
            }
        } else {
            appState.currentUser = null;
            const hash = window.location.hash;
            if (hash && hash.startsWith('#reset-password-')) {
                navigate(hash);
            } else {
                navigate('landing');
            }
        }
    }
    
    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        const result = await fetchData('/api/login', 'POST', { email, password });
        if (result) {
            appState.isAuthenticated = true;
            appState.currentUser = result.user;
            showFlashMessage(result.message, 'success');
            if (result.requiresPasswordChange) {
                navigate('change-password-view');
            } else {
                navigate('dashboard');
            }
        }
    }

    async function handleSignup(e) {
        e.preventDefault();
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        
        const result = await fetchData('/api/signup', 'POST', { name, email, password });
        if (result) {
            appState.isAuthenticated = true;
            appState.currentUser = result.user;
            showFlashMessage(result.message, 'success');
            navigate('dashboard');
        }
    }

    async function handleLogout() {
        const result = await fetchData('/api/logout', 'POST');
        if (result) {
            document.getElementById('login-form').reset();
            appState.isAuthenticated = false;
            appState.currentUser = null;
            appState.projects = [];
            showFlashMessage(result.message, 'info');
            navigate('landing');
        }
    }

    async function handleChangePassword(e) {
        e.preventDefault();
        const form = e.target;
        const formId = form.id;
        
        let currentPassword, newPassword, confirmNewPassword;

        if (formId === 'change-password-form') {
            currentPassword = document.getElementById('current-password').value;
            newPassword = document.getElementById('new-password').value;
            confirmNewPassword = document.getElementById('confirm-new-password').value;
        } else if (formId === 'forced-change-password-form') {
            currentPassword = document.getElementById('forced-current-password').value;
            newPassword = document.getElementById('forced-new-password').value;
            confirmNewPassword = document.getElementById('forced-confirm-new-password').value;
        } else {
            return;
        }

        if (newPassword !== confirmNewPassword) {
            showFlashMessage('As novas senhas não coincidem.', 'error');
            return;
        }
        
        const result = await fetchData('/api/change_password', 'POST', { currentPassword, newPassword, confirmNewPassword });
        if (result) {
            showFlashMessage(result.message, 'success');
            form.reset();
            if (profileModal.style.display === 'block') {
                closeProfileModal();
            }
            if (appState.currentUser && appState.currentUser.mudaSenha) {
                appState.currentUser.mudaSenha = false;
                navigate('dashboard');
            }
        }
    }

    async function handleForgotPassword(e) {
        e.preventDefault();
        const email = document.getElementById('forgot-email').value;
        const result = await fetchData('/api/forgot_password', 'POST', { email });
        if (result) {
            showFlashMessage(result.message, 'info');
            navigate('login');
        }
    }

    async function handleResetPassword(e) {
        e.preventDefault();
        const token = document.getElementById('reset-token').value;
        const newPassword = document.getElementById('reset-password').value;
        const confirmNewPassword = document.getElementById('reset-confirm-password').value;

        if (newPassword !== confirmNewPassword) {
            showFlashMessage('As novas senhas não coincidem.', 'error');
            return;
        }

        const result = await fetchData('/api/reset_password', 'POST', { token, newPassword, confirmNewPassword });
        if (result) {
            window.location.hash = ''; // Limpa o hash para evitar re-navegação
            showFlashMessage(result.message, 'success');
            navigate('login');
        }
    }

    function openProjectModal(project = null) {
        projectForm.reset();
        document.getElementById('project-id').value = '';
        if (project) {
            modalTitle.textContent = 'Editar Projeto';
            document.getElementById('project-id').value = project.id;
            document.getElementById('project-name').value = project.name;
            document.getElementById('project-description').value = project.description;
            document.getElementById('project-status').value = project.status;
        } else {
            modalTitle.textContent = 'Adicionar Novo Projeto';
        }
        projectModal.style.display = 'block';
        modalBackdrop.style.display = 'block';
    }

    function closeProjectModal() {
        projectModal.style.display = 'none';
        modalBackdrop.style.display = 'none';
    }

    async function handleProjectSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('project-id').value;
        const projectData = {
            name: document.getElementById('project-name').value,
            description: document.getElementById('project-description').value,
            status: document.getElementById('project-status').value
        };

        const result = id ? await fetchData(`/api/projects/${id}`, 'PUT', projectData) : await fetchData('/api/projects', 'POST', projectData);
        
        if (result) {
            showFlashMessage(result.message, 'success');
            closeProjectModal();
            await renderDashboard();
        }
    }
    
    function handleProjectEdit(id) {
        const project = appState.projects.find(p => p.id == id);
        if (project) {
            openProjectModal(project);
        }
    }

    async function handleProjectDelete(id) {
        if (confirm('Tem a certeza que deseja excluir este projeto?')) {
            const result = await fetchData(`/api/projects/${id}`, 'DELETE');
            if (result) {
                showFlashMessage(result.message, 'success');
                await renderDashboard();
            }
        }
    }

    function openProfileModal() {
        if(!appState.currentUser) return;
        document.getElementById('profile-name').value = appState.currentUser.nome || '';
        document.getElementById('profile-contact').value = appState.currentUser.contato || '';
        document.getElementById('profile-photo').value = appState.currentUser.foto && appState.currentUser.foto !== 'default.jpg' ? appState.currentUser.foto : '';
        
        document.getElementById('change-password-form').reset();

        profileModal.style.display = 'block';
        modalBackdrop.style.display = 'block';
    }

    function closeProfileModal() {
        profileModal.style.display = 'none';
        modalBackdrop.style.display = 'none';
    }

    async function handleProfileSubmit(e) {
        e.preventDefault();
        const name = document.getElementById('profile-name').value;
        const contact = document.getElementById('profile-contact').value;
        const photo = document.getElementById('profile-photo').value;

        const result = await fetchData('/api/profile', 'PUT', { nome: name, contato: contact, foto: photo });
        if (result) {
            showFlashMessage(result.message, 'success');
            appState.currentUser.nome = name;
            appState.currentUser.contato = contact;
            appState.currentUser.foto = photo || 'default.jpg';
            closeProfileModal();
            renderProfileDetails();
            renderAll(); // Atualiza o nome no header
        }
    }

    function setupEventListeners() {
        document.body.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            // Ação para botões de navegação com 'data-target'
            if (button.dataset.target) {
                e.preventDefault();
                navigate(button.dataset.target);
                return;
            }

            // Ação para botões específicos por ID
            switch (button.id) {
                case 'logout-btn':
                    e.preventDefault();
                    handleLogout();
                    break;
                case 'add-project-btn':
                    e.preventDefault();
                    openProjectModal();
                    break;
                case 'edit-profile-btn':
                    e.preventDefault();
                    openProfileModal();
                    break;
                case 'cancel-project-btn':
                    e.preventDefault();
                    closeProjectModal();
                    break;
                case 'cancel-profile-btn':
                    e.preventDefault();
                    closeProfileModal();
                    break;
            }

            // Ação para botões com classes específicas
            if (button.classList.contains('edit-project-btn')) {
                e.preventDefault();
                handleProjectEdit(button.dataset.id);
            }
            if (button.classList.contains('delete-project-btn')) {
                e.preventDefault();
                handleProjectDelete(button.dataset.id);
            }
        });
        
        document.getElementById('logo').addEventListener('click', (e) => {
            e.preventDefault();
            navigate(appState.isAuthenticated ? 'dashboard' : 'landing');
        });
        
        modalBackdrop.addEventListener('click', () => {
             closeProjectModal();
             closeProfileModal();
        });

        // Listeners para submissão de formulários
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('signup-form').addEventListener('submit', handleSignup);
        document.getElementById('project-form').addEventListener('submit', handleProjectSubmit);
        document.getElementById('profile-edit-form').addEventListener('submit', handleProfileSubmit);
        document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);
        document.getElementById('forced-change-password-form').addEventListener('submit', handleChangePassword);
        document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
        document.getElementById('reset-password-form').addEventListener('submit', handleResetPassword);

        window.addEventListener('hashchange', checkAuthStatus);
    }

    // --- Inicialização da Aplicação ---
    setupEventListeners();
    checkAuthStatus();
});
</script>

</body>
</html>
